{% extends "base_generic.html" %}
{% load static %}

{% block content %}
  <h2>Welcome, {{ user.username }}!</h2>
  <a href="{% url 'logout' %}">Logout</a>

  {% for number in floor_numbers %}
    <button class="floor-button" data-image="{{ number }}.png">{{ number }}</button>
  {% endfor %}

  <div id="floor-container" style="position: relative; display: inline-block;">
    <img id="floor-image" src="" alt="Floor image" style="display: none;">
    <div id="sensors-container" style="position: absolute; top: 0; left: 0; display: none;"></div>
  </div>

{% endblock %}

{% block extra_js %}
<script>
  var staticUrl = "{% get_static_prefix %}";

  document.querySelectorAll('.floor-button').forEach(function(button) {
    button.addEventListener('click', function(event) {
      var imageFile = event.target.getAttribute('data-image');
      var imageUrl = staticUrl + "{{ user.username }}/объект " + imageFile;
      var imageElement = document.getElementById('floor-image');
      imageElement.src = imageUrl;
      imageElement.onload = function() {
        imageElement.style.display = 'block';

        // Parse JSON
        fetch(staticUrl + "{{ user.username }}/sensors.json")
          .then(response => response.json())
          .then(data => {
            var sensorsContainer = document.getElementById('sensors-container');
            sensorsContainer.innerHTML = '';  // Clear previous sensors

            var sensors = data["объект " + imageFile];
            for (var i = 0; i < sensors.length; i++) {
              var sensor = sensors[i];
              var sensorButton = document.createElement('button');
              sensorButton.className = 'sensor-button';
              sensorButton.style.position = 'absolute';
              sensorButton.style.width = '30px'
              sensorButton.style.height = '30px'
              sensorButton.style.left = sensor['x_coordinate'] + 'px';
              sensorButton.style.top = sensor['y_coordinate'] + 'px';
              sensorButton.innerHTML = "<img src='" + staticUrl + sensor['sensor_type'] + ".png'>";
              sensorsContainer.appendChild(sensorButton);
            }

            sensorsContainer.style.display = 'block';
            sensorsContainer.style.width = imageElement.width + 'px';
            sensorsContainer.style.height = imageElement.height + 'px';
        });
      };
    });
  });
</script>
{% endblock %}
