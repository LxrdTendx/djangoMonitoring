{% load static %}

{% block content %}
  <head>
    <title>Welcome, {{ user.username }}!</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
  </head>
  <style>
    .side-section {
      min-width: 134px;
      max-width: 134px;
      min-height: 750px;
      max-height: 750px;
      background: #383639;
      box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
      border-radius: 0px 0px 20px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }



    .logo {
      margin-top: 29px;
    }

    .separator {
      width: 102px;
      height: 0;
      border: 1px solid #1F1F20;
      margin-top: 25px;
    }


    .floor-button {
      cursor: pointer;
      width: 60px;
      height: 60px;
      background: #1F1F20;
      color: #383639;
      border: none;
      box-shadow: inset 0px 4px 4px rgba(0, 0, 0, 0.25);
      border-radius: 30px;
      margin-bottom: 10px;
      text-align: center;
      font-family: 'Inter',sans-serif;
      font-style: normal;
      font-weight: 600;
      font-size: 24px;
      line-height: 29px;
      flex-shrink: 0;
    }

    .floor-button:hover {
      background: #FFFFFF;
      color: #1F1F20;
      transition: 1s;
      box-shadow: none;
    }

    .floor-button:focus {
      background: #FFFFFF;
      color: #1F1F20;
      box-shadow: none;
    }

    .floor-button.selected {
      background: #FFFFFF;
      color: #1F1F20;
    }

    .floor-buttons::-webkit-scrollbar {
      display: none; /* for Chrome, Safari, Opera */
    }

    .floor-buttons {
      -ms-overflow-style: none;  /* for IE and Edge */
      scrollbar-width: none;  /* for Firefox */
      height: 600px;
      overflow-y: scroll;  /* changed from 'hidden' to 'scroll' */
      padding: 10px 0;
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }

    body{
      zoom: 75%;
      background-color: #1F1F20;
      margin: 0;
    }

    .content-wrapper {
      display: flex;
      position: relative;
    }

    .logout-link {
      margin-bottom: 24px;
      text-decoration: none;
      font-family: 'Inter', sans-serif;
      font-style: normal;
      font-weight: 500;
      font-size: 24px;
      line-height: 29px;
      color: #FFFFFF;

      bottom:0;
    }

    .logout-icon {
        width: 41px; /* Установите размер изображения */
        height: 37px;
        background: url("{% static 'Logout.svg' %}") no-repeat;
    }

    .logout-link:hover .logout-icon {
        transition: 0.5s;
        background: url("{% static 'Logout-hover.svg' %}") no-repeat;
    }

    .graph-link {
      margin-bottom: 20px;
      text-decoration: none;
      font-family: 'Inter', sans-serif;
      font-style: normal;
      font-weight: 500;
      font-size: 24px;
      line-height: 29px;
      color: #FFFFFF;
      bottom:0;
    }

    .graph-icon {
        width: 61px; /* Установите размер изображения */
        height: 61px;
        background: url("{% static 'graph-none.svg' %}") no-repeat;
    }

    .graph-link:hover .graph-icon {
        transition: 0.5s;
        background: url("{% static 'graph-active.svg' %}") no-repeat;
    }

    .graph-link.active .graph-icon{
      transition: 0.5s;
      background: url("{% static 'graph-active.svg' %}") no-repeat;
    }

    .sensor-button {
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .sensor-button img {
      max-width: 100%;
      max-height: 100%;
    }

    .sensor-button.selected {
      box-shadow: 0 0 0 4px #009FE3;
      transition: 0.1s;
      border-radius: 5px;
    }

    #sensor-name{
      margin-left: 23px;
      color: white;
    }

    .block-date-time {
      width: 650px;
      height: 250px;
      background: #383639;
      box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
      border-radius: 20px;

    }
    .block-sensor-info {
      width: 650px;
      height: 250px;
      background: #383639;
      box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
      border-radius: 20px;
      margin-left: 23px;

    }
    #floor-container {
        margin-left: 23px;
      transition: 1s;
      position: relative;
      flex-wrap: nowrap; /* This allows the content to wrap if it exceeds the container's width */
    }
    #sensor{
      margin-bottom: 0px;
      margin-top: 29px;
      width: 431px;
      height: 83px;
      flex-direction: column;
      flex-shrink: 0;
      color: var(--main-white, #FFF);
      font-size: 36px;
      font-family: 'Inter',sans-serif;
      font-style: normal;
      font-weight: 700;
      line-height: normal;
    }
    #sensor-info-type{
      width: 378px;
      margin-top: 19px;
      color: var(--main-violet, #9960D2);
      font-size: 18px;
      font-family: 'Inter',sans-serif;
      font-style: normal;
      font-weight: 400;
      line-height: normal;
    }
    #sensor-date{
      margin-top: 28px;
      margin-bottom: 0px;
      width: 120px;
      color: var(--main-white, #FFF);
      font-size: 18px;
      font-family: 'Inter',sans-serif;
      font-style: normal;
      font-weight: 400;
      line-height: normal;
    }
    #sensor-time{
      margin-top: 28px;
      margin-bottom: 0px;
      margin-left: 80px;
      width: 130px;
      color: var(--main-white, #FFF);
      font-size: 18px;
      font-family: 'Inter',sans-serif;
      font-style: normal;
      font-weight: 400;
      line-height: normal;
    }
    .date_time-block{
      display: flex;
    }
    .info-sensors{
      margin-left: 34px;
      margin-top: 29px;
      margin-bottom: 0px;
      width: 499px;
      height: 52px;
      flex-direction: column;
      flex-shrink: 0;
      color: var(--main-white, #FFF);
      font-size: 36px;
      font-family: 'Inter',sans-serif;
      font-style: normal;
      font-weight: 700;
      line-height: normal;
    }
    .params{
      display: flex;
      width: 650px;
      margin-top: 31px;
    }
    #hum{
      margin-left: 34px;
    }
    #hum, #co2, #temp{
      width: 180px;
      margin-top: 0px;
      margin-bottom: 0px;
      color: var(--main-white, #FFF);
      margin-right: 130px;
      font-size: 36px;
      font-family: 'Inter',sans-serif;
      font-style: normal;
      font-weight: 700;
      line-height: normal;
    }
    #params-stats{
      margin-left: 34px;
      margin-top: 40px;
      font-size: 18px;
      font-family: 'Inter',sans-serif;
      font-style: normal;
      font-weight: 300;
      line-height: normal;
    }
    .block-date-time{
      display: flex;
    }
    .sensors_icon_type{
      margin-top: 42px;
      margin-left: 38px;
      margin-right: 27px;
      height: 140px;
      width: 140px;
    }
    .main-sector{
      margin-top: 32px;
    }
    .block-errors {
      font-family: 'Inter',sans-serif;
      background: #383639;
      box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
      border-radius: 20px;
      margin-left: 23px;
      height: 250px;
      width: 371px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      color:red;
      font-size: 20px;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .block-errors::-webkit-scrollbar{
      width: 0;
      height: 0;
    }
    ul{
      padding-left: 15px;
    }
    .error-message {
      border: 1px solid red;
      margin: 5px;
      /*padding: 10px;*/
    }
    canvas{

      margin: 0;
      padding: 0;
      font-size: 40px;
      /*margin-left: -400px;*/
      background-color: #383639;
      color: white;
      display: none;
      border-radius: 5px;
      box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);

    }
    .critical {
      filter: brightness(0.8) sepia(1) hue-rotate(-50deg) saturate(7) contrast(0.88);
    }
    .charts-block{
        justify-content: space-between;
      display: flex;
      width: auto;
    }
    h3, h2{
      font-family: 'Inter',sans-serif;
      color: #009FE3;
    }

    .thumbnail {
      width: 100px;
      height: auto;
      margin: 5px;
    }

    #thumbnails-container {
      margin-top: 20px;
      margin-left: 20px;
      background: #1F1F20;
      border: #1F1F20;
    }

    #thumbnails-container img{
      margin-right: 5px;
      margin-bottom: 5px;
      height: 300px;
      width: 500px;
      background-color: #1F1F20;
    }
    .thumbnail-button{
      background: #1F1F20;
      border: #1F1F20;
    }

    #thumbnails-container img:hover {
      border-radius: 3px;
      box-shadow: 0 0 5px 5px #009FE3;
      cursor: pointer;
      transition: 0.6s;

    }

        /* Общий стиль */
    #show-all-floors {
        margin-bottom: 20px;
        text-decoration: none;
        font-family: 'Inter', sans-serif;
        font-style: normal;
        font-weight: 500;
        font-size: 24px;
        line-height: 29px;
        color: #FFFFFF;
        bottom: 0;
    }

    /* Стиль для иконки */
    .floor-icon {
        width: 61px; /* Установите размер изображения */
        height: 61px;
        background: url("{% static 'mock-up.svg' %}") no-repeat;
    }

    /* Эффект при наведении */
    #show-all-floors:hover .floor-icon {
        transition: 0.5s;
        background: url("{% static 'mock-ups.svg' %}") no-repeat;
    }

    /* Эффект для активной кнопки */
    #show-all-floors.active .floor-icon {
        transition: 0.5s;
        background: url("{% static 'mock-ups.svg' %}") no-repeat;
    }
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
      }
      70% {
        box-shadow: 0 0 0 40px rgba(255, 0, 0, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
      }
    }


    .critical-sensor {
        border-radius: 5px;
        filter: brightness(50%) sepia(1) hue-rotate(-50deg) saturate(5);
        animation: pulse 2s infinite;
    }
    @media (min-width: 1920px) {
        body {
            zoom: 100%;
        }
      }

    .side-section-collapsed {
      width: 0;
      opacity: 0;
      display: none;
      overflow: hidden;
      transition: width 0.3s ease-out, opacity 0.3s ease-out;
    }

    .toggle-arrow {
      opacity: 70%;
      margin-top: 375px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      background: #1F1F20;
      color: #383639;
      text-align: center;
      line-height: 30px;
      font-size: 20px;
      transform: rotate(180deg);
      transition: transform 0.3s ease-out;
      border-radius: 30px;
    }
    .toggle-arrow:hover{
      opacity: 100%;
      color: #009FE3;
      transition: 0.6s;
    }

    .toggle-arrow.collapsed {
      transform: rotate(0deg); /* Стрелка вправо */
    }
    .body-critical {
      box-shadow: inset 0 0 250px 0 rgba(255, 0, 0, 0.3);
      transition: all 2s
  }








  </style>

  <div class="content-wrapper">
    <div class="side-section">
      <a href="{% url 'profile' %}">
        <img class="logo" src="{% static 'logo.png' %}" alt="Logo" >
      </a>
      <hr class="separator">
      <a class="graph-link" href="{% url 'monitoring' %}">
        <div class="graph-icon"></div>
      </a>
      <a id="show-all-floors" href="#">
          <div class="floor-icon"></div>
      </a>


      <div class="floor-buttons">
          {% for floor in floors %}
              <button class="floor-button" data-floor-number="{{ floor.floor_number }}" data-image="{{ floor.image.url }}">{{ floor.floor_number }}</button>
          {% endfor %}
      </div>

      <a class="logout-link" href="{% url 'logout' %}" >
          <div class="logout-icon"></div>
      </a>

    </div>

    <div class="toggle-arrow" id="toggleArrow">&#10148;</div>


    <div>
      <div id="floor-container" >
        <div id="information-blocks" style="display: flex; margin-top: 46px">
          <div class="block-date-time">
            <img src="{% static 'def_icon.png' %}" class="sensors_icon_type" id="sensors_icon_type">
            <div>
              <p id="sensor">Вид датчика</p>
              <p id="sensor-info-type">Параметры измерения датчика</p>
              <div class="date_time-block">
                <p id="sensor-date">Дата измерения</p>
                <p id="sensor-time">Время измерения</p>
              </div>
            </div>

          </div>
          <div class="block-sensor-info">
            <p class="info-sensors">Показатели</p>
            <div class="params">
              <p id="hum">%</p>
              <p id="co2">ppm</p>
              <p id="temp">℃</p>
            </div>
            <p id="params-stats"></p>
          </div>
          <div class="block-errors">
            <ul id="error-list" style="overflow-y: scroll; max-height: 300px; color: red">
            </ul>
          </div>
        </div>
        <div class="main-sector">
          <img id="floor-image" src="" alt="Floor image" style="top: 0; left: 0; display: none;">
          <div id="sensors-container" style="position: absolute; margin-top:285px; top: 0; left: 0; display: none; "></div>
        </div>

          <p id="sensor-name" style="display: none"></p>

          <div class="charts-block" style="">
            <div class="chart-container" style="height: 300px;width: 580px">
                <canvas id="humidityChart" style="width: auto;height: auto"></canvas>
            </div>

            <div class="chart-container" style="height: 300px;width: 580px">
                <canvas id="co2Chart" style="width: auto;height: auto"></canvas>
            </div>

            <div class="chart-container" style="height: 300px; width: 580px">
                <canvas id="temperatureChart" style="width: auto;height: auto"></canvas>
            </div>


          </div>


      </div>

      <div id="thumbnails-container" style="display: none;">
          {% for floor in floors %}
              <button class="thumbnail-button" data-floor-number="{{ floor.floor_number }}">
                  <img src="{{ floor.image.url }}" alt="Этаж {{ floor.floor_number }}">
              </button>
          {% endfor %}
      </div>

    </div>




  </div>

{% endblock %}



{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>



<script>
  document.getElementById('toggleArrow').addEventListener('click', function() {
  var sideSection = document.querySelector('.side-section');
  var arrow = document.getElementById('toggleArrow');

  // Переключаем класс для сайдбара и стрелки
  sideSection.classList.toggle('side-section-collapsed');
  arrow.classList.toggle('collapsed');
});
</script>


<script>
let temperatureChart;
let co2Chart;
let humidityChart;
let activeSensorName = null;
function updateOrCreateChart(chartInstance, chartId, label, data, chartType) {
    if (chartInstance) {
        chartInstance.destroy(); // Уничтожаем предыдущий график
    }
    return createChart(chartId, label, data, chartType); // Создаем новый график
}
function createChart(chartId, label, data, chartType) {
    var ctx = document.getElementById(chartId).getContext('2d');
    var backgroundColor, borderColor;
    console.log(chartType)
    // Определяем цвета в зависимости от типа графика
    switch (chartType) {
        case 'temperature':
            backgroundColor = 'rgba(255, 99, 132, 0.2)';
            borderColor = 'rgba(255, 99, 132, 1)';
            break;
        case 'co2':
            backgroundColor = 'rgba(75, 192, 192, 0.2)';
            borderColor = 'rgba(75, 192, 192, 1)';
            break;
        case 'humidity':
            backgroundColor = 'rgba(54, 162, 235, 0.2)';
            borderColor = 'rgba(54, 162, 235, 1)';
            break;
        default:
            backgroundColor = 'rgba(201, 203, 207, 0.2)';
            borderColor = 'rgba(201, 203, 207, 1)';
    }

    const maxValue = Math.max(...data.map(d => d.value));
    const yAxisMax = maxValue + (maxValue * 0.3); // Добавляем 10% отступа

    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.time),
            datasets: [{
                label: label,
                data: data.map(d => d.value),
                backgroundColor: backgroundColor,
                borderColor: borderColor,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    suggestedMax: yAxisMax
                }
            }
        }
    });
}
function updateSensorData(sensorName) {
    fetch('/get_sensor_data_history/' + sensorName + '/' + "{{ user.username }}")
    .then(response => response.json())
    .then(data => {
        // Предполагаем, что тип датчика приходит вместе с данными
        const sensorType = data.length > 0 ? data[0].type : null;
        data = data.slice(-30);
        if (sensorType === 'mult') {
            let temperatureData = data.map(item => ({ time: item.time, value: item.temperature }));
            let co2Data = data.map(item => ({ time: item.time, value: item.co2 }));
            let humidityData = data.map(item => ({ time: item.time, value: item.humidity }));

            // Обновляем или создаем графики для всех параметров
            temperatureChart = updateOrCreateChart(temperatureChart, 'temperatureChart', 'Temperature', temperatureData, 'temperature');
            co2Chart = updateOrCreateChart(co2Chart, 'co2Chart', 'CO2', co2Data, 'co2');
            humidityChart = updateOrCreateChart(humidityChart, 'humidityChart', 'Humidity', humidityData, 'humidity');
        } else if (sensorType === 'wet') {
            let humidityData = data.map(item => ({ time: item.time, value: item.humidity }));

            // Создаем или обновляем только график влажности
            humidityChart = updateOrCreateChart(humidityChart, 'humidityChart', 'Humidity', humidityData, 'humidity');

            // Уничтожаем ненужные графики, если они существуют
            if (temperatureChart) temperatureChart.destroy();
            if (co2Chart) co2Chart.destroy();
        }
    });
}
</script>

<script>
function isSensorCritical(sensorData) {
    // Проверяем тип датчика и определяем критичность в зависимости от типа
    if (sensorData['type'] === 'mult') {
        // Датчик типа mult - проверяем температуру, CO2 и влажность
        if (sensorData['temperature'] < 20 || sensorData['temperature'] > 24 ||
            sensorData['co2'] < 300 || sensorData['co2'] > 700 ||
            sensorData['humidity'] < 40 || sensorData['humidity'] > 60) {
            return true;
        }
    } else if (sensorData['type'] === 'wet') {
        // Датчик типа wet - проверяем только влажность
        if (sensorData['humidity'] < 40 || sensorData['humidity'] > 60) {
            return true;
        }
    }
    return false;
}
document.addEventListener('DOMContentLoaded', function() {
    let floorButtons = document.querySelectorAll('.floor-button');
    let floorImage = document.getElementById('floor-image');
    let sensorsContainer = document.getElementById('sensors-container');
    let selectedSensorButton = null;
    let selectedFloorButton = null;

    floorButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            // Если у нас есть предыдущая активная кнопка этажа, удаляем у нее класс "selected"
            if (selectedFloorButton) {
              selectedFloorButton.classList.remove('selected');
            }
            // Добавляем класс "selected" к только что нажатой кнопке
            event.target.classList.add('selected');
            // Обновляем ссылку на активную кнопку этажа
            selectedFloorButton = event.target;


            let floorImageUrl = button.getAttribute('data-image');
            floorImage.setAttribute('src', floorImageUrl);
            floorImage.style.display = 'block';

            let floorNumber = button.textContent;
            sensorsContainer.innerHTML = '';

            {% for sensor in sensors %}
                if ("{{ sensor.floor.floor_number }}" == floorNumber) {
                    let sensorBtn = document.createElement('button');
                    sensorBtn.classList.add('sensor-button');

                    let sensorIconPath;
                    if ("{{ sensor.sensor_type }}" == "mult") {
                        sensorIconPath = "{% static 'mult.png' %}";
                    } else if ("{{ sensor.sensor_type }}" == "wet") {
                        sensorIconPath = "{% static 'wet.png' %}";
                    }

                    sensorBtn.style.backgroundImage = `url(${sensorIconPath})`;
                    sensorBtn.style.position = 'absolute';
                    sensorBtn.style.left = "{{ sensor.x_coordinate }}px";
                    sensorBtn.style.top = "{{ sensor.y_coordinate }}px";
                    sensorBtn.title = "{{sensor.name}}"
                    sensorBtn.setAttribute('draggable', true);

                    let sensorName = "{{ sensor.name }}";

                    fetch('/get_sensor_data/' + sensorName + '/' + "{{ user.username }}")
                      .then(response => response.json())
                      .then(data => {
                          if (isSensorCritical(data)) {
                              sensorBtn.classList.add('critical-sensor');
                          } else {
                              sensorBtn.classList.remove('critical-sensor');
                          }
                    });
                    sensorBtn.addEventListener('click', function() {
                        activeSensorName = sensorName; // сохраняем имя активного датчика
                        updateSensorData(sensorName);
                        if (selectedSensorButton) {
                            selectedSensorButton.classList.remove('selected');
                        }
                        sensorBtn.classList.add('selected');
                        selectedSensorButton = sensorBtn;

                        fetch('/get_sensor_data/' + sensorName + '/' + "{{ user.username }}")
                        .then(response => response.json())
                        .then(data => {
                            let tempElement = document.getElementById('temp');
                            let co2Element = document.getElementById('co2');
                            let humElement = document.getElementById('hum');
                            let statsElement = document.getElementById('params-stats');
                            let isCritical = false;


                            if(data['type'] == 'mult') {
                              if (data['temperature'] >= 20 && data['temperature'] <= 22) {
                                tempElement.style.color = "#39FF27"; // Зеленый
                              } else if (data['temperature'] >= 20 && data['temperature'] <= 24) {
                                tempElement.style.color = "#FFA500"; // Оранжевый
                              } else {
                                tempElement.style.color = "#FF564B"; // Красный
                                isCritical = true;
                              }

                              if (data['co2'] >= 300 && data['co2'] <= 400) {
                                co2Element.style.color = "#39FF27"; // Зеленый
                              } else if (data['co2'] >= 400 && data['co2'] <= 700) {
                                co2Element.style.color = "#FFA500"; // Оранжевый
                              } else {
                                co2Element.style.color = "#FF564B"; // Красный
                                isCritical = true;
                              }
                              if (data['humidity'] >= 48 && data['humidity'] <= 52) {
                                humElement.style.color = "#39FF27"; // Зеленый
                              } else if (data['humidity'] >= 40 && data['humidity'] <= 60) {
                                humElement.style.color = "#FFA500"; // Оранжевый
                              } else {
                                humElement.style.color = "#FF564B"; // Красный
                                isCritical = true;
                              }
                              document.getElementById('temp').innerText = "℃:" +data['temperature'];
                            }

                            if (data['type'] == 'wet') {
                              co2Element.style.color = "#39FF27";
                              tempElement.style.color = "#39FF27";
                              if (data['humidity'] >= 48 && data['humidity'] <= 52) {
                                humElement.style.color = "#39FF27"; // Зеленый
                              } else if (data['humidity'] >= 40 && data['humidity'] <= 60) {
                                humElement.style.color = "#FFA500"; // Оранжевый
                              } else {
                                humElement.style.color = "#FF564B"; // Красный
                                isCritical = true;
                              }
                            }

                            if (isCritical) {
                              statsElement.innerText = "Есть критические показатели";
                              statsElement.style.color = "#FF564B";
                            } else {
                              statsElement.innerText = "Показатели в пределах нормы";
                              statsElement.style.color = "#39FF27";
                            }

                            if(data['type'] == 'mult'){
                              document.getElementById('sensor').innerText = "Мультидатчик параметров среды";
                              document.getElementById('sensor-info-type').innerText = "Датчик измеряет влажность, CO2 и температуру";
                              document.getElementById('sensors_icon_type').src = "{% static 'mult_icon.png' %}";
                              tempElement.innerText = "℃:" +data['temperature'];
                              co2Element.innerText = "ppm:" +data['co2'];
                              humElement.innerText = "%" + data['humidity'];
                            }
                            if(data['type'] == 'wet'){
                              document.getElementById('sensor').innerText = "Датчик влажности";
                              document.getElementById('sensor-info-type').innerText = "Датчик измеряет влажность";
                              document.getElementById('sensors_icon_type').src = "{% static 'hum_icon.png' %}";
                              tempElement.innerText = "";
                              co2Element.innerText = "";
                              humElement.innerText = "%" + data['humidity'];
                            }

                            document.getElementById('sensor-name').innerText = "Name: " + data['name'];
                            document.getElementById('sensor-time').innerText = data['time'];
                            document.getElementById('sensor-date').innerText = data['date'];
                            // document.getElementById('sensor-type').innerText = "Type: " + data['type'];
                          });
                    });

                    sensorsContainer.appendChild(sensorBtn);
                }
            {% endfor %}

            sensorsContainer.style.display = 'block';
        });
    });
});
setInterval(() => {
    if (activeSensorName) {
        updateSensorData(activeSensorName);
    }
}, 60000);

</script>
<script>
function updateSensorDisplay(sensorName, isCritical) {
    let sensorElements = document.querySelectorAll(`[title="${sensorName}"]`);
    let body = document.body;
    sensorElements.forEach(sensorElement => {
        if (isCritical) {
            sensorElement.classList.add('critical-sensor');
            body.classList.add('critical-animation');
        } else {
            sensorElement.classList.remove('critical-sensor');
            // body.classList.remove('critical-animation');
        }
    });
}

function updateBodyStyle(addStyle) {
    const body = document.body;
    if (addStyle) {
        body.classList.add('body-critical');
        setTimeout(() => {
            body.classList.remove('body-critical');
        }, 10000); // Удаление стиля через 10 секунд
    }
}

function checkForCriticalValues() {
    fetch('/get_floors_and_sensors/')
      .then(response => response.json())
      .then(data => {
        console.log(data)
        let floorNames = Object.keys(data);  // Например: ['Этаж 1', 'Этаж 2']
        floorNames.forEach(floorName => {
          let floorNum = floorName.split(' ')[1];
          let sensors = data[floorName];  // Получаем данные о датчиках для этого этажа
          sensors.forEach(sensor => {
            fetch('/get_sensor_data/' + sensor['name'] + '/' + "{{ user.username }}")
              .then(response => response.json())
              .then(data => {
                  let criticalParameters = [];
                  if (data['temperature'] === 0 && data['co2'] === 0 && data['humidity'] === 0) {
                      let errorBlock = document.querySelector('.block-errors');
                      let errorItem = document.createElement('ul');
                      let currentTime = new Date();
                      let timeStr = currentTime.getHours() + ":" + currentTime.getMinutes() + ":" + currentTime.getSeconds();
                      errorItem.innerText = `${sensor['name']} на этаже ${floorNum} в ${timeStr} неисправен`;
                      errorBlock.prepend(errorItem);
                      return;
                  }
                  if (data['type'] === 'mult') {
                      if (data['temperature'] < 20 || data['temperature'] > 24) {
                          criticalParameters.push('temperature');
                      }
                      if (data['co2'] < 300 || data['co2'] > 700) {
                          criticalParameters.push('co2');
                      }
                      if (data['humidity'] < 40 || data['humidity'] > 60) {
                          criticalParameters.push('humidity');
                      }
                  } else if (data['type'] === 'wet') {
                      if (data['humidity'] < 40 || data['humidity'] > 60) {
                          criticalParameters.push('humidity');
                      }
                  }

                  if (criticalParameters.length > 0) {
                      updateSensorDisplay(sensor['name'], true);
                      let errorBlock = document.querySelector('.block-errors');
                      let errorItem = document.createElement('ul');
                      let currentTime = new Date();
                      let timeStr = currentTime.getHours() + ":" + currentTime.getMinutes() + ":" + currentTime.getSeconds();
                      errorItem.innerText = `${sensor['name']} на этаже ${floorNum} в ${timeStr} критичные показатели: ${criticalParameters.join(', ')}`;
                      errorBlock.prepend(errorItem);
                      updateBodyStyle(true);
                  }
                  else {
                      updateSensorDisplay(sensor['name'], false); // Вызываем функцию с false, если критических показателей нет
                  }
              });
          });
        });
      });
  }


checkForCriticalValues();

// Запустить checkForCriticalValues каждую минуту
setInterval(checkForCriticalValues, 60000);

function clearErrors() {
  let errorBlock = document.querySelector('.block-errors');
  while (errorBlock.firstChild) {
    errorBlock.removeChild(errorBlock.firstChild);
  }
}

// Очистить блок с ошибками каждые 20 минут
setInterval(clearErrors, 1200000);

</script>




<script>
document.addEventListener('DOMContentLoaded', function() {
    var showAllFloorsButton = document.getElementById('show-all-floors');
    var floorContainer = document.getElementById('floor-container');
    var thumbnailsContainer = document.getElementById('thumbnails-container');
    var floorButtons = document.querySelectorAll('.floor-button');

    // Обработчик для кнопки "Показать все этажи"
    showAllFloorsButton.addEventListener('click', function() {
        floorContainer.style.display = 'none';
        thumbnailsContainer.style.display = 'block';
        showAllFloorsButton.classList.add('active');
    });

    // Обработчики для изображений этажей
    var thumbnailButtons = document.querySelectorAll('.thumbnail-button');
    thumbnailButtons.forEach(button => {
        button.addEventListener('click', function() {
            var floorNumber = button.getAttribute('data-floor-number');
            // Найдите и нажмите соответствующую кнопку этажа
            var correspondingFloorButton = document.querySelector('.floor-button[data-image="' + floorNumber + '"]');
            if (correspondingFloorButton) {
                correspondingFloorButton.click();
            }
        });
    });

    // Сбросить активное состояние при нажатии на кнопку этажа
    floorButtons.forEach(button => {
        button.addEventListener('click', function() {
            showAllFloorsButton.classList.remove('active');
            floorContainer.style.display = 'block';
            thumbnailsContainer.style.display = 'none';
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    var thumbnailButtons = document.querySelectorAll('.thumbnail-button');
    var floorButtons = document.querySelectorAll('.floor-button');

    // Функция для "нажатия" на кнопку этажа
    function openFloor(floorNumber) {
        floorButtons.forEach(button => {
            if (button.getAttribute('data-floor-number') == floorNumber) {
                button.click();
            }
        });
    }

    // Добавление обработчиков событий для миниатюр этажей
    thumbnailButtons.forEach(button => {
        button.addEventListener('click', function() {
            var floorNumber = button.getAttribute('data-floor-number');
            openFloor(floorNumber);
        });
    });
});

</script>

<!--<script>-->
<!--  var staticUrl = "{% get_static_prefix %}";-->
<!--  var selectedSensorButton = null;-->
<!--  var selectedFloorButton = null;-->
<!--  var refreshIntervalId = null;-->
<!--  var temperatureChartInstance = null;-->
<!--  var humidityChartInstance = null;-->
<!--  var co2ChartInstance = null;-->


<!--  var lineState = {-->
<!--    temperature: false,-->
<!--    co2: false,-->
<!--    humidity: false-->
<!--  };-->

<!--  var showAllFloorsButton = document.getElementById('show-all-floors');-->
<!--  var graphLink = document.querySelector('.graph-link');-->
<!--  var generateChartsIntervalId; // Store the id of the interval here-->

<!--  // Добавляем обработчик события при клике-->
<!--  graphLink.addEventListener('click', function() {-->
<!--    // Проверяем, есть ли у элемента класс 'active'-->
<!--    if (graphLink.classList.contains('active')) {-->
<!--      // Если класс 'active' есть, удаляем его-->
<!--      graphLink.classList.remove('active');-->
<!--      // graphLink.querySelector('.graph-icon').style.background = "url('{% static 'graph-none.svg' %}') no-repeat";-->
<!--      // Делаем #floor-container видимым-->
<!--      document.querySelector("#floor-container").style.display = "block";-->
<!--      document.querySelector("#statistic").style.display = "none"-->

<!--      // If the interval has been set, clear it-->
<!--      if (generateChartsIntervalId) {-->
<!--        clearInterval(generateChartsIntervalId);-->
<!--        generateChartsIntervalId = null;-->
<!--      }-->

<!--    } else {-->
<!--      // Если класса 'active' нет, добавляем его-->
<!--      graphLink.classList.add('active');-->
<!--      // graphLink.querySelector('.graph-icon').style.background = "url('{% static 'graph-active.svg' %}') no-repeat";-->
<!--      // Скрываем #floor-container-->
<!--      document.querySelector("#floor-container").style.display = "none";-->
<!--      document.querySelector("#thumbnails-container").style.display = "none"-->
<!--      document.querySelector("#statistic").style.display = "block"-->
<!--      showAllFloorsButton.classList.remove('active');-->
<!--      generateChartsForSensors();-->

<!--      // Set up the interval to generate the charts every 60 seconds-->
<!--      generateChartsIntervalId = setInterval(generateChartsForSensors, 60000);-->
<!--    }-->
<!--  });-->

<!--  var floorContainer = document.getElementById('floor-container');-->
<!--  var thumbnailsContainer = document.getElementById('thumbnails-container');-->

<!--  // Fetch and process the json file-->
<!--  fetch(staticUrl + "{{ user.username }}/sensors.json")-->
<!--    .then(response => response.json())-->
<!--    .then(data => {-->
<!--      // For each key in the object (which corresponds to a floor), create a thumbnail-->
<!--      Object.keys(data).forEach(function(floor) {-->
<!--          var imageElement = document.createElement('img');-->
<!--          imageElement.src = staticUrl + "{{ user.username }}/" + floor;-->
<!--          imageElement.style.width = "25%"; // scale down the size of the image-->

<!--          // Устанавливаем атрибут data-image для картинки-->
<!--          imageElement.setAttribute('data-image', floor);-->

<!--          thumbnailsContainer.appendChild(imageElement);-->
<!--      });-->

<!--    });-->

<!--  thumbnailsContainer.addEventListener('click', function(event) {-->
<!--    var clickedImg = event.target;-->
<!--    if (clickedImg.tagName === 'IMG') {-->
<!--        var fullFloorImage = clickedImg.getAttribute('data-image');-->


<!--        // Используем регулярное выражение, чтобы извлечь номер этажа из строки "объект 01.png"-->
<!--        var floorNumberMatch = fullFloorImage.match(/объект (\d+\.png)$/);-->
<!--        if (!floorNumberMatch) return;-->

<!--        // Ищем соответствующую кнопку этажа с использованием извлеченного номера этажа-->
<!--        var correspondingFloorButton = document.querySelector('.floor-button[data-image="' + floorNumberMatch[1] + '"]');-->
<!--        if (correspondingFloorButton) {-->
<!--            // Создаем новое событие-->
<!--            let newEvent = new MouseEvent('click', {-->
<!--                bubbles: true,-->
<!--                cancelable: true,-->
<!--                view: window-->
<!--            });-->
<!--            correspondingFloorButton.dispatchEvent(newEvent);-->
<!--        }-->
<!--    }-->
<!--});-->



<!--  // Add click event listener-->
<!--  showAllFloorsButton.addEventListener('click', function() {-->
<!--    if (thumbnailsContainer.style.display === "none") {-->
<!--      // Show thumbnails and hide the main content-->
<!--      thumbnailsContainer.style.display = "block";-->
<!--      document.querySelector("#statistic").style.display = "none"-->
<!--      floorContainer.style.display = "none";-->
<!--      graphLink.classList.remove('active');-->
<!--      // graphLink.querySelector('.graph-icon').style.background = "url('{% static 'graph-none.svg' %}') no-repeat";-->

<!--      this.classList.toggle('active');-->
<!--    } else {-->

<!--      // Hide thumbnails and show the main content-->
<!--      thumbnailsContainer.style.display = "none";-->
<!--      floorContainer.style.display = "block";-->
<!--      this.classList.remove('active');-->
<!--    }-->
<!--  });-->
<!--  function handleFloorButtonClick(event) {-->
<!--      document.querySelector("#floor-container").style.display = "block";-->
<!--      document.querySelector("#statistic").style.display = "none"-->
<!--      document.querySelector("#thumbnails-container").style.display = "none"-->

<!--      var imageFile = event.target.getAttribute('data-image');-->
<!--      var imageUrl = staticUrl + "{{ user.username }}/объект " + imageFile;-->
<!--      var imageElement = document.getElementById('floor-image');-->
<!--      imageElement.src = imageUrl;-->
<!--      imageElement.onload = function() {-->
<!--        imageElement.style.display = 'block';-->

<!--        if (selectedFloorButton) {-->
<!--          selectedFloorButton.classList.remove('selected');-->
<!--        }-->

<!--        event.target.classList.add('selected');-->
<!--        selectedFloorButton = event.target;-->
<!--        var graphLink = document.querySelector('.graph-link');-->
<!--        if (graphLink.classList.contains('active')) {-->
<!--          graphLink.classList.remove('active');-->
<!--          // graphLink.querySelector('.graph-icon').style.background = "url('{% static 'graph-none.svg' %}') no-repeat";-->
<!--        }-->
<!--        var showAllFloorsButton = document.querySelector('#show-all-floors')-->
<!--        if (showAllFloorsButton.classList.contains('active')) {-->
<!--          showAllFloorsButton.classList.remove('active');-->
<!--          // showAllFloorsButton.querySelector('#show-all-floors').style.background = "url('{% static 'mock-up.svg' %}') no-repeat";-->
<!--        }-->
<!--        console.log(imageFile)-->
<!--        fetch(staticUrl + "{{ user.username }}/sensors.json")-->
<!--          .then(response => response.json())-->
<!--          .then(data => {-->
<!--            var sensorsContainer = document.getElementById('sensors-container');-->
<!--            sensorsContainer.innerHTML = '';-->
<!--            console.log(imageFile)-->
<!--            var sensors = data["объект " + imageFile];-->
<!--            for (var i = 0; i < sensors.length; i++) {-->
<!--              let sensor = sensors[i];-->
<!--              let sensorButton = document.createElement('button');-->
<!--              sensorButton.className = 'sensor-button';-->
<!--              sensorButton.style.position = 'absolute';-->
<!--              sensorButton.style.marginLeft = sensor['x_coordinate'] + 'px';-->
<!--              sensorButton.style.marginTop = sensor['y_coordinate'] + 'px';-->

<!--              let sensorImage = document.createElement('div');-->
<!--              sensorImage.className = 'sensor-image';-->

<!--              let sensorImgElement = document.createElement('img');-->
<!--              sensorImgElement.src = staticUrl + sensor['sensor_type'] + ".png";-->

<!--              sensorImage.appendChild(sensorImgElement);-->
<!--              sensorButton.appendChild(sensorImage);-->


<!--              // Create overlayDiv outside the interval and fetch-->
<!--              let overlayDiv = document.createElement('div');-->
<!--              overlayDiv.style.position = 'absolute';-->
<!--              overlayDiv.style.top = '0';-->
<!--              overlayDiv.style.left = '0';-->
<!--              overlayDiv.style.width = '100%';-->
<!--              overlayDiv.style.height = '100%';-->
<!--              overlayDiv.style.borderRadius='5px';-->
<!--              sensorButton.appendChild(overlayDiv);-->

<!--              function checkSensorData() {-->
<!--                  fetch('/get_sensor_data/' + sensor['sensor_name'] + '/' + "{{ user.username }}")-->
<!--                      .then(response => response.json())-->
<!--                      .then(data => {-->
<!--                          let isCritical = false;-->

<!--                          if(data['type'] == 'mult' || data['type'] == 'wet') {-->
<!--                              if (data['humidity'] < 40 || data['humidity'] > 60) {-->
<!--                                  isCritical = true;-->
<!--                              }-->
<!--                          }-->

<!--                          if(data['type'] == 'mult') {-->
<!--                              if (data['temperature'] < 20 || data['temperature'] > 24) {-->
<!--                                  isCritical = true;-->
<!--                              }-->

<!--                              if (data['co2'] < 350 || data['co2'] > 700) {-->
<!--                                  isCritical = true;-->
<!--                              }-->
<!--                          }-->

<!--                          if (isCritical) {-->
<!--                              overlayDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.5)';  // полупрозрачный красный фон-->
<!--                          } else {-->
<!--                              overlayDiv.style.backgroundColor = 'transparent'; // Remove the red color if not critical-->
<!--                          }-->
<!--                      });-->
<!--              }-->

<!--              // Call function once immediately-->
<!--              checkSensorData();-->

<!--              // Start the interval-->
<!--              setInterval(checkSensorData, 10000);-->

<!--              sensorButton.addEventListener('click', (function(sensor) {-->
<!--                return function() {-->
<!--                    if (selectedSensorButton) {-->
<!--                      selectedSensorButton.classList.remove('selected');-->
<!--                    }-->
<!--                    sensorButton.classList.add('selected');-->
<!--                    selectedSensorButton = sensorButton;-->

<!--                    var updateData = function (){-->
<!--                      fetch('/get_sensor_data/' + sensor['sensor_name'] + '/' + "{{ user.username }}")-->
<!--                        .then(response => response.json())-->
<!--                        .then(data => {-->

<!--                          let tempElement = document.getElementById('temp');-->
<!--                          let co2Element = document.getElementById('co2');-->
<!--                          let humElement = document.getElementById('hum');-->
<!--                          let statsElement = document.getElementById('params-stats');-->

<!--                          let isCritical = false;-->
<!--                          if(data['type'] == 'mult') {-->
<!--                            if (data['temperature'] >= 20 && data['temperature'] <= 22) {-->
<!--                              tempElement.style.color = "#39FF27"; // Зеленый-->
<!--                            } else if (data['temperature'] >= 20 && data['temperature'] <= 24) {-->
<!--                              tempElement.style.color = "#FFA500"; // Оранжевый-->
<!--                            } else {-->
<!--                              tempElement.style.color = "#FF564B"; // Красный-->
<!--                              isCritical = true;-->
<!--                            }-->

<!--                            if (data['co2'] >= 300 && data['co2'] <= 400) {-->
<!--                              co2Element.style.color = "#39FF27"; // Зеленый-->
<!--                            } else if (data['co2'] >= 400 && data['co2'] <= 700) {-->
<!--                              co2Element.style.color = "#FFA500"; // Оранжевый-->
<!--                            } else {-->
<!--                              co2Element.style.color = "#FF564B"; // Красный-->
<!--                              isCritical = true;-->
<!--                            }-->
<!--                            if (data['humidity'] >= 48 && data['humidity'] <= 52) {-->
<!--                              humElement.style.color = "#39FF27"; // Зеленый-->
<!--                            } else if (data['humidity'] >= 40 && data['humidity'] <= 60) {-->
<!--                              humElement.style.color = "#FFA500"; // Оранжевый-->
<!--                            } else {-->
<!--                              humElement.style.color = "#FF564B"; // Красный-->
<!--                              isCritical = true;-->
<!--                            }-->
<!--                          }-->

<!--                          if (data['type'] == 'wet') {-->
<!--                            co2Element.style.color = "#39FF27";-->
<!--                            tempElement.style.color = "#39FF27";-->
<!--                            if (data['humidity'] >= 48 && data['humidity'] <= 52) {-->
<!--                              humElement.style.color = "#39FF27"; // Зеленый-->
<!--                            } else if (data['humidity'] >= 40 && data['humidity'] <= 60) {-->
<!--                              humElement.style.color = "#FFA500"; // Оранжевый-->
<!--                            } else {-->
<!--                              humElement.style.color = "#FF564B"; // Красный-->
<!--                              isCritical = true;-->
<!--                            }-->
<!--                          }-->

<!--                          if (isCritical) {-->
<!--                            statsElement.innerText = "Есть критические показатели";-->
<!--                            statsElement.style.color = "#FF564B";-->
<!--                          } else {-->
<!--                            statsElement.innerText = "Показатели в пределах нормы";-->
<!--                            statsElement.style.color = "#39FF27";-->
<!--                          }-->

<!--                          if(data['type'] == 'mult'){-->
<!--                            document.getElementById('sensor').innerText = "Мультидатчик параметров среды";-->
<!--                            document.getElementById('sensor-info-type').innerText = "Датчик измеряет влажность, CO2 и температуру";-->
<!--                            document.getElementById('sensors_icon_type').src = staticUrl + "mult_icon.png";-->
<!--                            tempElement.innerText = "℃:" +data['temperature'];-->
<!--                            co2Element.innerText = "ppm:" +data['co2'];-->
<!--                            humElement.innerText = "%" + data['humidity'];-->
<!--                          }-->
<!--                          if(data['type'] == 'wet'){-->
<!--                            document.getElementById('sensor').innerText = "Датчик влажности";-->
<!--                            document.getElementById('sensor-info-type').innerText = "Датчик измеряет влажность";-->
<!--                            document.getElementById('sensors_icon_type').src = staticUrl + "hum_icon.png";-->
<!--                            tempElement.innerText = "";-->
<!--                            co2Element.innerText = "";-->
<!--                            humElement.innerText = "%" + data['humidity'];-->
<!--                          }-->

<!--                          document.getElementById('sensor-name').innerText = "Name: " + data['name'];-->
<!--                          document.getElementById('sensor-time').innerText = data['time'];-->
<!--                          document.getElementById('sensor-date').innerText = data['date'];-->
<!--                          document.getElementById('sensor-type').innerText = "Type: " + data['type'];-->
<!--                        });-->
<!--                      fetch('/get_sensor_data_history/' + sensor['sensor_name'] + '/' + "{{ user.username }}")-->
<!--                        .then(response => response.json())-->
<!--                        .then(data => {-->
<!--                            let timesall = data.map(item => new Date(item['date'] + ' ' + item['time']));-->
<!--                            let temperaturesall = data.map(item => item['temperature']);-->
<!--                            let humidityall = data.map(item => item['humidity']);-->
<!--                            let co2all = data.map(item => item['co2']);-->

<!--                            let times = timesall.slice(-20);-->
<!--                            let humidity = humidityall.slice(-20);-->
<!--                            let temperatures = temperaturesall.slice(-20);-->
<!--                            let co2 = co2all.slice(-20);-->
<!--                            // document.getElementById('sensor-name').innerText = times + '\n' + temperatures;-->
<!--                            let temperatureCtx = document.getElementById('temperatureChart').getContext('2d');-->
<!--                            let humidityCtx = document.getElementById('humidityChart').getContext('2d');-->
<!--                            let co2Ctx = document.getElementById('co2Chart').getContext('2d');-->

<!--                            // ctx.style.backgroundColor = 'rgba(0, 159, 227, 1)';-->
<!--                            if (temperatureChartInstance != null) {-->
<!--                              temperatureChartInstance.destroy();-->
<!--                            }-->

<!--                            temperatureChartInstance = new Chart(temperatureCtx, {-->
<!--                                type: "line",-->
<!--                                data: {-->
<!--                                  labels: times,-->
<!--                                  datasets: [-->
<!--                                    {-->
<!--                                      label: "Температура",-->
<!--                                      backgroundColor: "red",-->
<!--                                      borderColor: "#FFA07A",-->
<!--                                      tension: 0.4,-->
<!--                                      data: temperatures,-->

<!--                                    },-->
<!--                                  ]-->
<!--                                },-->
<!--                                options:{-->
<!--                                  events: ['mousemove', 'mouseout', 'click', 'touchstart', 'touchmove', 'touchend', 'mouseenter', 'mouseleave'],-->
<!--                                  maintainAspectRatio: false,-->
<!--                                  plugins:{-->
<!--                                    legend:{-->
<!--                                      labels:{-->
<!--                                        // font:{-->
<!--                                        //   size:16-->
<!--                                        // }-->
<!--                                      }-->
<!--                                    }-->
<!--                                  },-->
<!--                                  scales:{-->
<!--                                    x:{-->
<!--                                      display: false,-->
<!--                                      ticks: {-->
<!--                                        font:{-->
<!--                                          size: 40,-->
<!--                                        },-->
<!--                                      },-->
<!--                                      grid:{-->
<!--                                        color: 'ccc'-->
<!--                                      }-->
<!--                                    },-->
<!--                                    y:{-->
<!--                                      // ticks:{-->
<!--                                      //   font: {-->
<!--                                      //     size:16,-->
<!--                                      //   },-->
<!--                                      //   color: '#009FE3'-->
<!--                                      // }-->
<!--                                    }-->
<!--                                  },-->
<!--                                }-->
<!--                              });-->
<!--                            if (humidityChartInstance != null) {-->
<!--                              humidityChartInstance.destroy();-->
<!--                            }-->
<!--                            humidityChartInstance = new Chart(humidityCtx, {-->
<!--                                type: "line",-->
<!--                                data: {-->
<!--                                  labels: times,-->
<!--                                  datasets: [-->
<!--                                    {-->
<!--                                      label: "Влажность",-->
<!--                                      backgroundColor: "blue",-->
<!--                                      borderColor: "#009FE3",-->
<!--                                      data: humidity,-->
<!--                                      tension: 0.4-->
<!--                                    },-->
<!--                                  ]-->
<!--                                },-->
<!--                                options:{-->
<!--                                  maintainAspectRatio: false,-->
<!--                                  plugins:{-->
<!--                                    legend:{-->
<!--                                      labels:{-->
<!--                                        // font:{-->
<!--                                        //   size:16-->
<!--                                        // }-->
<!--                                      }-->
<!--                                    }-->
<!--                                  },-->
<!--                                  scales:{-->
<!--                                    x:{-->
<!--                                      display: false,-->
<!--                                      ticks: {-->
<!--                                        font:{-->
<!--                                          size: 40,-->
<!--                                        },-->
<!--                                      },-->
<!--                                      grid:{-->
<!--                                        color: 'ccc'-->
<!--                                      }-->
<!--                                    },-->
<!--                                    y:{-->
<!--                                      // ticks:{-->
<!--                                      //   font: {-->
<!--                                      //     size:16,-->
<!--                                      //   },-->
<!--                                      //   color: '#009FE3'-->
<!--                                      // }-->
<!--                                    }-->
<!--                                  },-->
<!--                                }-->
<!--                              });-->
<!--                            if (co2ChartInstance != null) {-->
<!--                              co2ChartInstance.destroy();-->
<!--                            }-->
<!--                            co2ChartInstance = new Chart(co2Ctx, {-->
<!--                                type: "line",-->
<!--                                data: {-->
<!--                                  labels: times,-->
<!--                                  datasets: [-->
<!--                                    {-->
<!--                                      label: "СО2",-->
<!--                                      backgroundColor: "green",-->
<!--                                      borderColor: "lightgreen",-->
<!--                                      tension: 0.4,-->
<!--                                      data: co2,-->

<!--                                    },-->
<!--                                  ]-->
<!--                                },-->
<!--                                options:{-->
<!--                                  maintainAspectRatio: false,-->
<!--                                  plugins:{-->
<!--                                    legend:{-->
<!--                                      labels:{-->
<!--                                        // font:{-->
<!--                                        //   size:16-->
<!--                                        // }-->
<!--                                      }-->
<!--                                    }-->
<!--                                  },-->
<!--                                  scales:{-->
<!--                                    x:{-->
<!--                                      display: false,-->
<!--                                      ticks: {-->
<!--                                        font:{-->
<!--                                          size: 40,-->
<!--                                        },-->
<!--                                      },-->
<!--                                      grid:{-->
<!--                                        color: 'ccc'-->
<!--                                      }-->
<!--                                    },-->
<!--                                    // y:{-->
<!--                                    //   ticks:{-->
<!--                                    //     font: {-->
<!--                                    //       size:16,-->
<!--                                    //     },-->
<!--                                    //     color: '#009FE3'-->
<!--                                    //   }-->
<!--                                    // }-->
<!--                                  },-->
<!--                                }-->
<!--                              });-->
<!--                        });-->

<!--                    }-->
<!--                    updateData();-->
<!--                    if (refreshIntervalId !== null) {-->
<!--                      clearInterval(refreshIntervalId);  // останавливаем обновление предыдущего датчика-->
<!--                    }-->
<!--                    refreshIntervalId = setInterval(updateData, 60000);-->

<!--                }-->

<!--            })(sensor));-->

<!--              sensorsContainer.appendChild(sensorButton);-->
<!--            }-->

<!--            sensorsContainer.style.display = 'block';-->
<!--            sensorsContainer.style.width = imageElement.width + 'px';-->
<!--            sensorsContainer.style.height = imageElement.height + 'px';-->
<!--        });-->
<!--      };-->
<!--}-->
<!--  document.querySelectorAll('.floor-button').forEach(function(button) {-->
<!--      button.addEventListener('click', handleFloorButtonClick);-->
<!--  });-->
<!--  function checkForCriticalValues() {-->
<!--    fetch(staticUrl + "{{ user.username }}/sensors.json")-->
<!--      .then(response => response.json())-->
<!--      .then(data => {-->
<!--        // get the floor number from the object-->
<!--        let floors = Object.keys(data);-->
<!--        floors.forEach(floor => {-->
<!--          let floorNum = floor.split(' ')[1].replace('.png', ''); // 'объект 01.png' => 01-->
<!--          let sensors = data[floor];-->
<!--          sensors.forEach(sensor => {-->
<!--            fetch('/get_sensor_data/' + sensor['sensor_name'] + '/' + "{{ user.username }}")-->
<!--              .then(response => response.json())-->
<!--              .then(data => {-->
<!--                  let criticalParameters = [];-->
<!--                  if (data['temperature'] === 0 && data['co2'] === 0 && data['humidity'] === 0) {-->
<!--                      let errorBlock = document.querySelector('.block-errors');-->
<!--                      let errorItem = document.createElement('ul');-->
<!--                      let currentTime = new Date();-->
<!--                      let timeStr = currentTime.getHours() + ":" + currentTime.getMinutes() + ":" + currentTime.getSeconds();-->
<!--                      errorItem.innerText = `${sensor['sensor_name']} на этаже ${floorNum} в ${timeStr} неисправен`;-->
<!--                      errorBlock.prepend(errorItem);-->
<!--                      return;-->
<!--                  }-->
<!--                  if (data['type'] === 'mult') {-->
<!--                      if (data['temperature'] < 20 || data['temperature'] > 24) {-->
<!--                          criticalParameters.push('temperature');-->
<!--                      }-->
<!--                      if (data['co2'] < 300 || data['co2'] > 700) {-->
<!--                          criticalParameters.push('co2');-->
<!--                      }-->
<!--                      if (data['humidity'] < 40 || data['humidity'] > 60) {-->
<!--                          criticalParameters.push('humidity');-->
<!--                      }-->
<!--                  } else if (data['type'] === 'wet') {-->
<!--                      if (data['humidity'] < 40 || data['humidity'] > 60) {-->
<!--                          criticalParameters.push('humidity');-->
<!--                      }-->
<!--                  }-->

<!--                  if (criticalParameters.length > 0) {-->
<!--                      let errorBlock = document.querySelector('.block-errors');-->
<!--                      let errorItem = document.createElement('ul');-->
<!--                      let currentTime = new Date();-->
<!--                      let timeStr = currentTime.getHours() + ":" + currentTime.getMinutes() + ":" + currentTime.getSeconds();-->
<!--                      errorItem.innerText = `${sensor['sensor_name']} на этаже ${floorNum} в ${timeStr} критичные показатели: ${criticalParameters.join(', ')}`;-->
<!--                      errorBlock.prepend(errorItem);-->
<!--                  }-->
<!--              });-->
<!--          });-->
<!--        });-->
<!--      });-->
<!--  }-->
<!--  checkForCriticalValues();-->


<!--  // Запустить checkForCriticalValues каждую минуту-->
<!--  setInterval(checkForCriticalValues, 60000);-->
<!--  function clearErrors() {-->
<!--    let errorBlock = document.querySelector('.block-errors');-->
<!--    while (errorBlock.firstChild) {-->
<!--      errorBlock.removeChild(errorBlock.firstChild);-->
<!--    }-->
<!--  }-->

<!--  // Очистить блок с ошибками каждые 20 минут-->
<!--  setInterval(clearErrors, 1200000);-->

<!--  function checkSensors() {-->
<!--      document.querySelectorAll('.sensor-button').forEach(function(sensorButton) {-->
<!--          let sensorName = sensorButton.getAttribute('data-sensor-name');-->
<!--          fetch('/get_sensor_data/' + sensorName + '/' + "{{ user.username }}")-->
<!--              .then(response => response.json())-->
<!--              .then(data => {-->
<!--                  let isCritical = false;-->

<!--                  if (data['temperature'] < 20 || data['temperature'] > 24) {-->
<!--                    isCritical = true;-->
<!--                  }-->
<!--                  if (data['co2'] < 350 || data['co2'] > 700) {-->
<!--                      isCritical = true;-->
<!--                  }-->
<!--                  if (data['humidity'] < 40 || data['humidity'] > 60) {-->
<!--                      isCritical = true;-->
<!--                  }-->

<!--                  let overlayDiv = sensorButton.querySelector('div');-->
<!--                  if (isCritical) {-->
<!--                      if (!overlayDiv) {-->
<!--                          overlayDiv = document.createElement('div');-->
<!--                          overlayDiv.style.position = 'absolute';-->
<!--                          overlayDiv.style.top = '0';-->
<!--                          overlayDiv.style.left = '0';-->
<!--                          overlayDiv.style.width = '100%';-->
<!--                          overlayDiv.style.height = '100%';-->
<!--                          overlayDiv.style.borderRadius='5px';-->
<!--                          overlayDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.5)';  // полупрозрачный красный фон-->
<!--                          sensorButton.appendChild(overlayDiv);-->
<!--                      }-->
<!--                  } else {-->
<!--                      if (overlayDiv) {-->
<!--                          sensorButton.removeChild(overlayDiv);-->
<!--                      }-->
<!--                  }-->
<!--              });-->
<!--      });-->
<!--  }-->

<!--  // Запускаем функцию checkSensors каждую минуту-->
<!--  setInterval(checkSensors, 60000);-->


<!--</script>-->
{% endblock %}







